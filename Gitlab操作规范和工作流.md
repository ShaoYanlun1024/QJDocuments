# 千家网络Gitlab操作规范和工作流

| 整理 | 版本 | 日期       | 描述                                      |
| ---- | ---- | ---------- | ----------------------------------------- |
| 张鹏 | 1.0  | 2018.12.13 | 初稿                                      |
| 张鹏 | 1.1  | 2018.12.20 | 修正分支合并操作流程                      |
| 张鹏 | 1.2  | 2018.12.22 | 增加Issue的关闭                           |
| 张鹏 | 1.3  | 2018.12.24 | 增加Issue的预估耗时，实际完成耗时操作说明 |
| 张鹏 | 1.4  | 2019.01.18 | 增加对应Gitlab的项目组各岗位职责          |
| 张鹏 | 1.5  | 2019.02.23 | 整理岗位职责表格(合并同类/相似内容)       |
| 张红烁|1.6  | 2019.03.15 | 增加RC里程碑、无法确定截止时间里程碑操作规范  |
| 张红烁|1.7  | 2019.03.18 | 修改建议模板                              |
| 刘秋月 | 1.8 | 2019.04.08 | 增加上线前检查清单模板                  |
| 刘秋月 | 1.9 | 2019.04.24 | 增加里程碑关闭前代码审查以及上线清单检查项 |
| 刘秋月 | 1.9.1 | 2019.04.24 | 增加里程碑建立时第一个issue存放预演成果的约定 |

---

## 目录
- [分支](#分支)
- [工单](#工单)
- [提交](#提交)
- [里程碑](#里程碑)
- [岗位职责](#岗位职责)

---

## 分支

| 分支            | 命名         | 说明                                                         |
| --------------- | ------------ | ------------------------------------------------------------ |
| 发布分支        | master       | 永远是可用的、稳定的、可直接发布的版本，不能直接在该分支上开发 |
| 线上bug修复分支 | hotfix/xxx   | 项目上线之后可以会遇到一些环境问题需要紧急修复，在master分支上创建，流程跟release分支相似，修复完成后合并到develop和master分支 |
| 开发主分支      | dev          | 代码永远是最新，所有新功能以这个分支来创建自己的开发分支，该分支只做只合并操作，不能直接在该分支上开发 |
| 功能开发分支    | dev-feat/xxx | 功能开发分支，在dev上创建分支，以自己开发功能模块命名，功能测试正常后合并到dev分支 |
| bug修复分支     | dev-fix/xxx  | 开发bug修复分支，在dev上创建分支，以自己开发功能模块命名，功能测试正常后合并到dev分支 |
| 预发布分支      | release      | 在合并好feature分支的develop分支上创建，主要是用来测试bug的分支，修改好bug并确定稳定之后合并到develop和master分支，然后发布master分支 |
| bug修复分支     | fix/xxx      | 在release上创建分支修复，修复好测试出来的bug之后合并回develop分支 |

>`注：表格中的 "xxx" 为 Issue 编号`

注意事项：
- 一个分支开发一个功能模块，`不允许多个功能模块在一个分支上开发`
- 开发过程中，如果组员A开发的功能依赖组员B正在开发的功能，可以待组员B开发好相关功能之后，组员A直接pull组员B的分支下来开发，不需要先将组员B的分支 merge 到develop分支
- feature 分支在申请合并之前，`必须`先 pull 一下 develop 主分支下来，看一下有没有冲突，如果有就先解决冲突后再申请合并

[**<p align="right">>>返回目录<<</p>**](#目录)

## 工单

### 以下情况使用Issue：
- 发现软件的bug并报告
- 需求发起的讨论(discuss)，讨论结束后需在评论中添加讨论结果链接并关闭该issue或提升该issue为plan（添加标签）
- 计划的任务和功能(plan and feature)
- 来自客户的想法 (idea)

### 创建模板：
1. 创建 issue 模板  
    在 .gitlab/issue_templates/ 目录下新建一个 Markdown 格式文件 (.md)，并推送至远端默认分支
2. 创建 merge request 模板  
    在 .gitlab/merge_request_templates/ 目录下新建一个 Markdown 格式文件 (.md)，并推送至远端默认分支

### 使用模板:
    假设现在已经有一个 .gitlab/issue_templates/Bug.md Bug 模板，当你新建或编辑一个 issue 时将会有个下拉框允许你选择 Bug 模板，选择后 Bug 模板的内容将会被拷贝至 issue 的描述框内，此外 GitLab 还会提供一个重置模板的按钮让你在做出错误修改后能够重置到模板的初始状态。

### 针对千家网络的现行开发流程，可设置如下类型的模板：
    - 待安排（针对已确定的需求准备着手进行开发）
    - 想法,讨论（郑子玉
    - 建议，Bug （小姜）
    - 合并请求 (张金龙)

待安排模板：

```shell
## 描述
```

Bug报告模板：
```shell
## 测试步骤

1. 
2. 
3. 
4. 

## 测试结果

## 期望结果

## 附件
```
建议模板：
```shell
### 建议说明

```
填写自己的建议想法，为什么要这样做
```
### 讨论说明

```
填写自己的论证依据，为什么这么做是合理的
```
### 建议/讨论结果

```
填写最后结果
```

合并请求：
```shell
## 修改类型（必填）

- [x] bug修复  
- [x] 需求添加

## 内容

1. 修改issue编号
2. 其他
```

上线前检查项清单：
```shell
## 上线检查项

- [ ] 备份生产数据库所有数据
- [ ] 备份生产环境源代码
- [ ] 检查生产环境配置文件，是否存在开发环境覆盖生产环境配置
- [ ] 检查生产环境canal黑名单
- [ ] 新导入的数据表，并且需要同步到es中，检查数据是否同步成功
- [ ] 生产环境发布之后，如果进行了测试，必须及时清理测试数据
- [ ] 生产环境发布时，检查接口版本号是否影响原有功能的使用
- [ ] 前端项目发布之前，先在本地build一遍，build没有问题，在通知运维组发布
- [ ] 前端项目检查webpack配置项，要求必须有dev、pred、prod构建配置，且互不影响
- [ ] 预生产环境的测试数据和生产环境同步的测试结果是否通过
- [ ] 发布生产之前，必须进行代码审查，由前后端开发负责人发起审查
- [ ] 发布生产后，开发人员先自测主流程
- [ ] 发布生产，针对并发量较高的项目需进行压力测试（千家电话、人才库、鉴权授权中心、外网、人脸识别、会务助手）
- 
```

### <font color="red">Issue的耗时</font>
- 开发人员领取 issue 后，首先在评论框中输入"/"，在随后出现的快捷录入项中选择 `estimate` (预估耗时), 后面跟预计耗时
- 开发人员关闭 issue 前，首先在评论框中输入"/"，在随后出现的快捷录入项中选择 `spend` (实际耗时), 后面写实际完成用时

>耗时编写格式：
- w 周
- d 天
- h 小时
- m 分钟

例如小明领取了工单`个人中心页面改版`，首先需要在评论框中输入 `/estimate 1d` 表示预计需要一个工作日的时间可以完成；实际完成时，在评论框中输入 `/spent 1d 6h` 表示实际完成耗时1个工作日+6个小时

>移除耗时的指令：   
- /remove_estimate 移除预估耗时
- /remove_time_spent 移除时间耗时 


### <font color="red">**Issue的关闭**</font>
- 开发过程中， issue的关闭由开发人员自行关闭，关闭之前需要标记为“已完成”并设置“完成日期”(Due Date);
- 测试人员提出的标记为bug的issue，由测试人员回归完成后关闭并设置完成日期;
- 其他类型的issue，完成后，如果有成果文档的，需要在该issue后附加评论，并链接该文档，任务指派人对任务成果进行审核通过后，由任务指派人关闭该issue并设置完成日期;

参考：[Gitlab模板](http://hueyhe.com:8213/blog/2017/08/24/description-template-gitlab/)
[**<p align="right">>>返回目录<<</p>**](#目录)

## 提交

完成编码工作后需要向对应分支提交编码成果，提交操作须关联对应的issue:

如下提交方式均为正确的提交：

```
git commit -m '实现了xx功能 issue #1, #2'  
```

```
git commit -m 'issue #1, #2'
```

```
git commit -m '
    > 调整样式
    > 重构x功能
    > 重构xx方法
    > issue #1'
```

>`提交信息越完善越有助于团队成员之间的高效协作！`  
>`提交信息越完善越有助于团队成员之间的高效协作！`  
>`提交信息越完善越有助于团队成员之间的高效协作！`

三种提交命令说明：
1. `git commit -m "message"`  

    -m 参数表示可以直接输入后面的message，如果不加 -m 参数，那么是不能直接输入message的，而是会调用一个编辑器一般是vim来让你输入这个message

2. `git commit -a -m "message"`  

    -a 参数表示，可以将所有已跟踪文件中的执行修改或删除操作的文件都提交到本地仓库，即使它们没有经过git add添加到暂存区。

    `注意`，新加的文件（即没有被git系统管理的文件）是不能被提交到本地仓库的。建议一般不要使用-a 参数，正常的提交还是使用git add先将要改动的文件添加到暂存区，再用git commit 提交到本地版本库

3. `git commit --amend`  

   追加提交，它可以在不增加一个新的commit-id的情况下将新修改的代码追加到前一次的commit-id中。




>注意：基于千家网络现有的工作流程，不允许直接在提交信息中使用 `closed`, `fixed` 和 `resolved` 关键字,只有测试组成员才可以使用上述标签

[**<p align="right">>>返回目录<<</p>**](#目录)

## 里程碑

综述
- 千家网络通过 Gitlab Milestone 对开发工作的内容与时间节点进行管理
- 所有工作相关的Issue需放入里程碑
- 开发预演成果作为里程碑的第一个issue(时序图/流程图/预演讨论结果记录)

### 里程碑的命名
- 里程碑需按照 项目名称 - 版本号 的方式来命名，例如：  千家MIS.活动助手 - 1.6.0
- 部分工作可能在一开始是相对临时性的，不具备可迭代性，建议可以0.1来标识里程碑版本号；这样做的目的是，当工作内容发生增加时，避免出现一个一直不能关闭的里程碑

>`注意：产品负责人应规划好里程碑的版本，直到交付用户一个可用的版本之前，里程碑版本号不得超过1.0`

### 里程碑的完成时间
- 里程碑在创建后，需尽快标记截止时间。截止时间不要求精确无误差，但需要有理有据；
- 项目负责人需要尽快落实里程碑的时间依据；
- 当里程碑时间出现变更，需要由项目负责人发一个 issue 来说明变更的原因；
- 对于只是初步制定了里程碑内容，无法确定开发时间的里程碑，截止时间可暂不指定；

### 里程碑的发起
- 当打算开始进行一项工作时，需要发起一个新的Issue，说明该工作目前已知的情况，已知的参与者，或者需要招募的参与者；
- 所有便于组织内其他开发者理解工作内容，理解需求，有助于进行时间和风险评估的内容，都放入里程碑发起的 issue;
- 建立里程碑，将该 issue 放入，并尽快确定里程碑完成时间

### 里程碑的过程管理
- 所有与该工作相关的 issue, 创建后即放入该里程碑；
- 项目负责人应注意及时把未正确指定里程碑的 issue 放入对应里程碑

### 里程碑的关闭
里程碑的关闭需要满足三个条件：
1. 里程碑中的 issue 都已关闭；
2. 里程碑涉及的工作已产生成果；
3. 关闭里程碑之前进行代码审查，并且要有相关的issue记录说明，以及后续的重构issue引用。


当满足上述条件时，项目负责人关闭里程碑。
- 注：当此里程碑为紧急修复bug的RC里程碑，在下一个迭代里程碑结束前会是一直开启的状态，可暂时不关闭。

### 里程碑的变更
1. 比较小的变更，作为时间变更，发 issue 说明原因；
2. 比较大的变更，或工作增加，项目负责人考虑后，可发新的里程碑，命名增加版本号；

### 合并
1. 项目负责人`审查代码`并发起合并请求(从dev到release)
2. 项目运维负责人审查合并请求，合格的合并请求须包括如下内容：
    - 简短准确的文字描述
    - 关联本次合并已解决的issue编号
3. 测试组进行回归测试（预发布分支），测试通过后标记”已回归“并发表评论：已通过交叉回归测试。并提交合并请求，在该请求下进行评论并@产品负责人，核实无误后，产品负责人@运维负责人， 运维负责人见到产品负责人的评论后进行合并。
4. 运维组接到测试组针对本次合并的评论和标签后进行合并

[**<p align="right">>>返回目录<<</p>**](#目录)


## 岗位职责

对应Gitlab的角色，开发人员各岗位职责如下：

| Gitlab角色 | 千家网络岗位     | 职责                                            |
| ---------- | ---------------- | ----------------------------------------------- |
| 主程序员   | 产品经理         | 1. 需求宣讲直到达成共识                         |
|            |                  | 2. 用户故事编写                                 |
|            |                  | 3. 任务指派                                     |
|            | 前后端项目负责人 | 1. 保障开发环境、预发环境以及生产环境数据一致性 |
|            |                  | 2. 代码审查(单元测试/接口规范/Git规范)          |
|            |                  | 3. 代码合并                                     |
|            |                  | 4. 组织开发人员分解用户故事，预估工时           |
|            |                  | 5. 组内事务/问题处理                            |
|            | 运维组           | 1. 代码合并/构建/运行保障                       |
| 开发人员   | 项目组开发人员   | 1. 开发和测试                                   |
|            |                  | 2. 持续稳定的交付                               |
| 报告者     | 测试人员         | 1. 冒烟、交叉、回归测试                         |
|            |                  | 2. 自动化接口/UI测试                            |
|            | 质控人员         | Git规范检查及结果登记，扣罚执行                 |
|            | UI设计人员       | 1. 快速原型/设计稿                              |
|            |                  | 2. 设计规范执行检查                             |
|            |                  | 3. 页面还原检查                                 |
|            |                  | 4. 迭代设计                                     |
| 访客       | 实习生           | 学习                                            |
|            | 领导             | 监督抽查                                        |

[**<p align="right">>>返回目录<<</p>**](#目录)