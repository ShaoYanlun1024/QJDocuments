# 基本代码规范
本篇规范制定了代码基本元素的相关标准，以确保共享的PHP代码间具有较高程度的技术互通性。

本规范参考PHP标准规范中基础编码规范PSR-1，根据公司实际情况做了少量修改，[查看PSR-1规范](https://learnku.com/docs/psr/basic-coding-standard/1605)

关于「能愿动词」的使用
为了避免歧义，文档大量使用了「能愿动词」，对应的解释如下：

    必须 (MUST)：绝对，严格遵循，请照做，无条件遵守；
    一定不可 (MUST NOT)：禁令，严令禁止；
    应该 (SHOULD) ：强烈建议这样做，但是不强求；
    不该 (SHOULD NOT)：强烈不建议这样做，但是不强求；
    可以 (MAY) 和 可选 (OPTIONAL) ：选择性高一点，在这个文档内，此词语使用较少；

参见：[RFC 2119](http://www.ietf.org/rfc/rfc2119.txt)

## 概览

* PHP代码文件 **必须** 以 `<?php` 标签开始；
* PHP代码文件 **必须** 以 `不带 BOM 的 UTF-8` 编码；
* PHP代码中 **应该** 只定义类、函数、常量等声明，或其他会产生 `副作用` 的操作（如：生成文件输出以及修改 .ini 配置文件等），二者只能选其一；
* 命名空间以及类 **必须** 符合 **PSR** 的自动加载规范：[PSR-4](https://learnku.com/docs/psr/psr-4-autoloader/1608)；
* 类的命名 **必须** 遵循 `StudlyCaps` 大写开头的驼峰命名规范；
* 类中的常量所有字母都 **必须** 大写，单词间用下划线分隔；
* 方法名称 **必须** 符合 `camelCase` 式的小写开头驼峰命名规范。

## 文件
1. PHP标签
PHP代码 **必须** 使用 `<?php ?>` 长标签； **一定不可** 使用其它自定义标签。
2. 字符编码
PHP代码 **必须** 且只可使用 `不带BOM的UTF-8` 编码。
3. 副作用
一份 **PHP** 文件中 **应该** 要不就只定义新的声明，如类、函数或常量等不产生 `副作用` 的操作，要不就只书写会产生 `副作用` 的逻辑操作，但 **不该** 同时具有两者。

「副作用」(side effects) 一词的意思是，仅仅通过包含文件，不直接声明类、函数和常量等，而执行的逻辑操作。

「副作用」包含却不仅限于：

* 生成输出
* 直接的 require 或 include
* 连接外部服务
* 修改 ini 配置
* 抛出错误或异常
* 修改全局或静态变量
* 读或写文件等

以下是一个 `反例`，一份包含「函数声明」以及产生「副作用」的代码：

	<?php
	
	// 「副作用」：修改 ini 配置 	
	ini_set('error_reporting', E_ALL); 
	
	// 「副作用」：引入文件 
	include "file.php"; 
	
	// 「副作用」：生成输出 
	echo "<html>\n"; 
	
	// 声明函数 
	function foo() 
	{
	    // 函数主体部分 
	}

下面是一个范例，一份只包含声明不产生「副作用」的代码：

	<?php
	
	// 声明函数 
	function foo() 
	{ 
	    // 函数主体部分 
	} 
	
	// 条件声明 **不** 属于「副作用」 
	if (! function_exists('bar')) {
	    function bar() 
	    {
	        // 函数主体部分 
	    } 
	}

## 命名空间和类
命名空间以及类的命名 **必须** 遵循「自动加载」规范 [PSR-4](https://learnku.com/docs/psr/psr-4-autoloader)。

根据规范，每个类都独立为一个文件，且命名空间至少有一个层次：顶级的组织名称（vendor name）。

类的命名 **必须** 遵循 `StudlyCaps` 大写开头的驼峰命名规范。

枚举类使用 `Enum` 结尾。

抽象类命名使用 `Abstract `或 `Base `开头；

异常类命名使用 `Exception` 结尾；

测试类命名以它要测试的类的名称开始，以 `Test `结尾。

PHP 5.3 及以后版本的代码 **必须** 使用正式的命名空间。

例如：

	<?php 
	// PHP 5.3及以后版本的写法 
	namespace Vendor\Model; 
	
	class Foo 
	{
	
	}
	
 
## 类的常量、属性和方法
此处的「类」指代所有的类、接口以及可复用代码块（traits）

1. 常量

类的常量中所有字母都 **必须** 大写，词间以下划线分隔。

枚举类使用 Enum 结尾

参照以下代码：

	<?php 
	namespace Vendor\Model;
	
	class Foo 
	{ 
		const VERSION = '1.0'; 
		const DATE_APPROVED = '2012-06-01';
	}
2.
 属性
 
 类的属性命名 **可以** 遵循：

* 大写开头的驼峰式 ($StudlyCaps)
* 小写开头的驼峰式 ($camelCase)
* 下划线分隔式 ($under_score)


本规范较PSR-1规范更严格，要求 **必须** 使用 `小写开头的驼峰式 ($camelCase)`。

 3.
方法

* 方法名称 **必须** 符合 `camelCase()` 式的小写开头驼峰命名规范。

* 重写方法必须添加 `@Override` 注释。
* 过时的类和方法必须添加 `@Deprecated` 注释，并说明原因。
* **禁止** 使用已过时的类和方法。
* 相同参数类型，相同业务含义，才可以使用 `PHP` 的可变参数，避免使用 `Object`。
* 类成员与方法访问控制从严：
    1. 如果不允许外部直接通过 new 来创建对象，那么构造方法必须是 `private`。
    2. 工具类不允许有 `public` 构造方法。
    3. 类非 static 成员变量并且与子类共享，必须是 `protected`。
    4. 类非 static 成员变量并且仅在本类使用，必须是 `private`。
    5. 类 static 成员变量如果仅在本类使用，必须是 `private`。
    6. 若是 static 成员变量，必须考虑是否为 `final`。
    7. 类成员方法只供类内部调用，必须是 `private`。
    8. 类成员方法只对继承类公开，那么限制为 `protected`。
    9. 所有成员及方法都必须设置访问控制。
    10. 方法参数中有默认值的参数必须放到参数列表末尾。
    11. 如果方法的参数类型为对象必须指定参数类型为具体的类名,如果为array必须指定类型为array。

## 注释规范

### 代码中不许出现大段代码注释（提交历史中已有这些代码，不必担心丢失）

1. **文件注释**
    >    - 作者 `author`
    >    - 描述 `description`
    >    - 日期 `date`
    
    ```PHP
    /**
      * @Author: wangshuai
      * @Description: 注释说明
      * @Date: Created in 10:55 2018/4/14
    */
     ```
2. **方法注释**（用多行注释）(PHPDoc)
    >    - 作者 `author`
    >    - 日期 `date`
    >    - 功能描述 `information`
    >    - 修改日期 `update`
    >    - 修改目的 
    
     ```PHP
    /**
      * @Author: wangshuai
      * @Date: Created in 10:55 2018/4/14
      * @Description: 功能
      * @param String 参数1 说明
      * @param Int 参数2 说明
    */
    ```
3. **单行注释** 
    >    - 方法内的注释可以使用单行注释 
    >    - 实体 `swagger` 注释
    >    - controller层 `swagger` 注释
    
## 单元测试

* 一个测试类只对应一个被测类，当前的测试类应该与其他的测试类、环境设置等没有任何依赖。
* 测试类的目录结构和被测试类的对应，这样便于快速找到错误位置。
* 一个测试方法只测试一个方法。同时，确保不要测试私有方法，它们是被封装起来的，并不是API。
* 保持你的测试是幂等的。测试程序应该能运行多次保持结果一致，不论运行一次还是一百万次，它的效果都应该是一样的。
* 断言，把断言从逻辑中分离出来。断言应该用来检验结果，不应该执行逻辑操作的。
* 覆盖率，要求所有主要业务均要有对应的单元测试，每个service类都需有对应的单元测试。
* mocks，合理mock数据或服务（如网络资源、依赖的其他服务）

## 其他说明
1. 建议经常使用 `代码格式化` 功能（PHPStorm快捷键Ctrl+Alt+L）。
2. **禁止** 使用魔法值，**酌情** 使用常量或枚举。
3. 在使用事务时必须制定 `rollback` 或 `手动回滚`。