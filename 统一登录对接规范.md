## 统一登录对接文档

整理人 | 整理时间 | 版本 | 描述
-- | -- | -- | --
张金龙 | 2019-06-08 | 1.0 | 初稿

#### 项目对接

现有项目分散开发不能满足现有业务需求，需要将各个分散的子项目统一合并到统一登录中，为了能让各个子项目独立开发独立部署，对接时使用`iframe`，确保各个子项目中能够与统一登录完成对接，并能确保后端能够拿到相应的数据权限，需要使用`iframe`进行父子通信，在项目中添加文件。

```javaScript
//  iframeProxy.js
const globalPath = new Map([
    ['development', {
        domain: "qj.com",
        portal: "http://wrp.qj.com"
    }],
    ['lan', {
        domain: "qj.com",
        portal: "http://wrp.qj.com"
    }],
    ['pred', {
        domain: "allhome.com.cn",
        portal: "https://dmis.allhome.com.cn"
    }],
    ['production', {
        domain: "allhome.com.cn",
        portal: "https://mis.allhome.com.cn"
    }]
])

const env = process.env.NODE_ENV;
!function proxyInit() {
  if (!(window && document)) 
    console.log('缺少浏览器环境');
  try {
    document.domain = globalPath.has(env) ? globalPath.get(env).domain : document.domain;
  } catch(err) {}

  //  挂载代理
  Object.defineProperty(window, 'token', {
    get: function() { return parent.window.globalToken; },
    set: function(val) { parent.window.globalToken = val; },
    configurable: true
  })
  //  挂载退出方法
  window.logout = function() {
    let {globalLogout} = parent.window;
    globalLogout 
        ? globalLogout()
        : window.location = globalPath.has(env) 
                                ? globalPath.get(env).portal 
                                : "https://mis.allhome.com.cn";
  }
  //  通知刷新菜单资源
  window.refreshMenus = function() {
    let {globalRefreshMenus} = parent.window;
    globalRefreshMenus && globalRefreshMenus();
  }
  window.refreshHeader = function() {
    let {globalRefreshHeader} = parent.window;
    globalRefreshHeader && globalRefreshHeader();
  }
}();
```

使用：

在`axios`拦截器中使用，并拦截获取`token`。

```javaScript
import axios from 'axios';
axios.defaults.timeout = 60000;
const interFaces = {
    "development":"http://************",
    "lan":"http://************",
    "pred":"http://************",
    "production":"http://************"
};
axios.defaults.baseURL = interFaces[process.env.NODE_ENV];
axios.interceptors.response.use((res) => {
  let {message, result, statusCode} = res.data;
  let logoutCodes = new Set([435001, 435011, 436050]);
  if (statusCode === 1000) {
    //  获取token;
    let {pragma} = res.headers;
    if (pragma) window.token = pragma;
    return result;
  } 
  else if (logoutCodes.has(statusCode)) {
    //  调用退出登录方法
    setTimeout(() => window.logout(), 1000);
    return Promise.reject({message});
  }
  else{
    return Promise.reject({message,statusCode});
  }
}, (error) => {
  return Promise.reject(error.response.data);
});
axios.interceptors.request.use(function (config) {
  config.headers.token = window.token || "";
  return config;
}, function (error) {
  return Promise.reject(error);
});
export default axios;
```

除了上述所说的方法，用于子项目数据请求`loading`，不需要再在各个子项目中处理，而是使用统一登录，需要调用父页页面的`loading`方法。该`loading`与`element-ui`的`loading`使用方法一致。

##### 按钮权限

添加文件

```javaScript
import Vue from "vue";
Vue.directive('by', {
    bind(...argument) {
    //  dom节点，binding属性
    let [el,banding] = argument;
    //  获取到元素绑定数据
    let permis = el.getAttribute("limit");
    //  权限列表
    let {value:permisList} = banding;
    //  当前权限是否存在
    let flag = permisList.includes(permis);
    //  如果不存在，删除节点
    !flag && el.parentNode && el.parentNode.removeChild(el);
  }
})
```

使用

```javaScript
// 引用 main.js
import "./directive.js"
// 使用
<div v-by:restricts="arg" limit="4">123</div>
```

`arg`则是通过`token`请求该用户对应的按钮权限数据，将其绑定到自定义指令后面即可。

##### loading

当页面加载的时候需要使用`loading`，由于这个loading是使用的父页面的`loading`方法需要在子页面关闭。

在各个子项目中添加如下代码

```javaScript
window.parent.$instance && window.parent.$instance.close();
```

除此之外，在父页级中添加了`$loading`方法。可以通过`window.parent.$loading`调用，此方法使用与`element-ui`中的方法一样。

##### 子项目用户操作缓存

方法未定











































